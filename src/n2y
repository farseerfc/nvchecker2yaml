#!/bin/sh

#显示帮助信息
showhelp() {
    echo "This is a simple tool to help maintainers switch from nvchecker.ini to lilac.yaml"
    echo "For more informations about lilac.yaml, see https://archlinuxcn.github.io/lilac/"
    echo
    echo "The semi-automated process follows the following steps: "
    echo "  - Ask for the directory where your local clone of Arch CN repo locates"
    echo "  - Ask for your email (the same one you put in nvchecker.ini)"
    echo "  - Check for all your packages that haven't been switched to lilac.yaml"
    echo "  - For every package that hasn't been switched: "
    echo "      - Auto fit pre_build, post_build, post_build_always, "
    echo "        time_limit_hours, update_on and maintainers in lilac.yaml"
    echo "      - Ask if you want to change some of the above ones (especially maintainers)"
    echo "      - If you used to use the archlinuxcn build prefix, ask if you want to "
    echo "        use the new depends feature. Auto-fill this item is a considerable feature."
    echo "      - Generate a preview of the new yaml file"
    echo "      - Save to lilac.yaml, trim lilac.py and remove the package from nvchecker.ini"
    echo "      - Git commit with message 'Switch [pkgname] to lilac.yaml'"
    echo
    echo "Specify a package or several packages will start the process for only those packages"
    echo
    echo "Use --help to view this message"
}

for n2ycmdi in $(seq 1 $#); do
    eval "n2ycmd=\${${n2ycmdi}}"
    if [[ ${n2ycmd} = "--help" ]]; then
        showhelp
        exit 0
    fi
    n2ypkgnames[${n2ycmdi}]=${n2ycmd}
done

#获取CN源本地克隆地址
read -p "Path to your local clone of Arch CN repo [Current path]: " n2yrepodir

#默认使用当前目录
if [[ ! ${n2yrepodir} ]]; then
    n2yrepodir=$PWD
fi

#规范化路径
n2yrepodir=${n2yrepodir%\/}

#检查路径合法性
#nvchecker.ini
if [[ ! -f ${n2yrepodir}\/nvchecker.ini ]]; then
    echo "${n2yrepodir}/nvchecker.ini not found! This path is invalid. "
    exit 255
fi
#.git
if [[ ! -d ${n2yrepodir}\/.git ]]; then
    echo "${n2yrepodir}/ is not a git repo! This path is invalid. "
    exit 255
fi